<!DOCTYPE html>
<html lang="en">
  <!-- Head partial -->
  <%- include("partials/_head", { page: "View Reports" }) %>
  <body>
    <!-- Nav Partial -->
    <%- include("partials/_nav") %>

    <!-- Security Classification -->
    <%- include("partials/_security_classification", { classification:
    "unclassified" }) %>

    <!-- View Reports -->
    <div class="d-flex justify-content-center mt-5">
      <button id="reports-view-geo-btn" class="w-50 btn btn-success d-none">Visualize</button>    
      <div
        id="reports-table-loading"
        class="spinner-border text-primary"
        role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <table
      id="reports-table"
      class="invisible w-100 table table-sm table-bordered table-hover"
    >
      <thead class="thead-dark">
        <tr>
          <% Object.keys(fieldNames).forEach(field => { %>
          <th style="vertical-align: middle; text-align: center">
            <%= fieldNames[field] %>
          </th>
          <% }) %>
        </tr>
      </thead>
      <tbody>
        <% Object.values(reports).forEach(report => { %> <%-
        include("partials/_view_report_table_row", { report, fieldNames }); %>
        <% }) %>
      </tbody>
      <tfoot>
        <% Object.keys(fieldNames).forEach(field => { %>
        <th style="vertical-align: middle; text-align: center">
          <%= fieldNames[field] %>
        </th>
        <% }) %>
      </tfoot>
    </table>

    <!-- View Specific Scripts -->
    <!-- Datatables init -->
    <script
      type="text/javascript"
      src="/js/datatables/datatables.min.js"
    ></script>
    <!-- Datatables buttons styler -->
    <link
      rel="stylesheet"
      type="text/css"
      href="/js/datatables/datatables.min.css"
    />
    <!-- Popper.js -->
    <script type="text/javascript" src="/js/popper.min.js"></script>
    <!-- On load, convert the table to a data table -->
    <script>
      $(document).ready(() => {
        // Hide the loader and show the table and geo button
        $("#reports-table").removeClass("invisible");
        $("#reports-view-geo-btn").removeClass("d-none");
        $("#reports-table-loading").remove();

        const table = $("#reports-table").DataTable({
          // Scroll x plane
          scrollX: true,
          // Allow column reorder
          colReorder: true,
          // Notes column max length 64 char
          columnDefs: [
            {
              targets: [-4, -3],
              className: "truncate",
              render: function (data) {
                return `<a data-toggle="popover" data-trigger="focus" tabindex="0" data-content="${data}">${data}</a>`;
              },
            },
          ],
          // Add search panes for 5 columns
          searchPanes: {
            threshold: 1,
            columns: [4, 5, 6, 8, 12, 14, -1],
          },
          // Enable route in app.js to put workload on server
          //serverSide: true,
          //ajax: {
          //    url: '/data-source',
          //    type: 'POST'
          //}
          dom:
            "<'row'<'my-2 query-builder col-sm-12 col-md-12 col-lg-12'Q>>" +
            "<'row'<'float-lg-right col-sm-4 col-md-4 col-lg-9'B><'col-sm-4 col-md-4 col-lg-1'l><'col-sm-4 col-md-4 col-lg-2'f>>" +
            "<'row'<'col-sm-12 col-md-4'i><'col-sm-12 col-md-8'p>>" +
            "<'row'<'col-lg-12'tr>>",
          buttons: ["copy", "excel", "csv", "pdf", "print", "colvis", { text: 'Toggle Search Panes', action: () => 
      $(".dtsp-container").fadeToggle()}],
        });

        // Add the search panes to the table top
        table.searchPanes.container().prependTo(table.table().container());

        // Enable tooltips
        $(function () {
          $('[data-toggle="popover"]').popover({ trigger: "hover" });
        });

        // On table draws, update rows and rebuilt popovers
        // Current visible rows
        currentRows = [...table.columns({ search: 'applied' }).data()[0]];
        table.on("draw", function () {
          $('[data-toggle="popover"]').popover({ trigger: "hover" });
          // Current visible rows
          currentRows = table.columns({ search: 'applied' }).data()[0];
        });

         // On geo button click, move to map with data
        $("#reports-view-geo-btn").click(() => {
          console.log(currentRows)
          const form = $(`
            <form action="/geo" method="post">
              <input type="text" name="report_ids" value="${currentRows}"/>
            </form>`);
          $("body").append(form);
          form.submit();
        });
      });

    </script>
  </body>
</html>
