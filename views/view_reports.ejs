<!DOCTYPE html>
<html lang="en">
  <!-- Head partial -->
  <%- include("partials/_head", { page: "View Reports" }) %>
  <body>
    <!-- Nav Partial -->
    <%- include("partials/_nav") %>

    <!-- Security Classification -->
    <%- include("partials/_security_classification", { classification:
    "unclassified" }) %>

    <!-- View Reports -->
    <div class="d-flex justify-content-center mt-5">
      <button id="reports-view-geo-btn" class="w-50 btn btn-success d-none">Visualize</button>    
      <div
        id="reports-table-loading"
        class="spinner-border text-primary"
        role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <table
      id="reports-table"
      class="invisible w-100 table table-sm table-bordered table-hover"
    >
      <thead class="thead-dark">
        <tr>
          <% Object.keys(fieldNames).forEach(field => { %>
          <th style="vertical-align: middle; text-align: center">
            <%= fieldNames[field] %>
          </th>
          <% }) %>
        </tr>
      </thead>
      <tfoot class="thead-dark">
        <% Object.keys(fieldNames).forEach(field => { %>
        <th style="vertical-align: middle; text-align: center">
          <%= fieldNames[field] %>
        </th>
        <% }) %>
      </tfoot>
    </table>

    <!-- View Specific Scripts -->
    <!-- Datatables init -->
    <script
      type="text/javascript"
      src="/js/datatables/datatables.min.js"
    ></script>
    <!-- Datatables buttons styler -->
    <link
      rel="stylesheet"
      type="text/css"
      href="/js/datatables/datatables.min.css"
    />
    <!-- Popper.js -->
    <script type="text/javascript" src="/js/popper.min.js"></script>
    <!-- Moment.js -->
    <script type="text/javascript" src="/js/moment.js"></script>
    <!-- On load, convert the table to a data table -->
    <script>
      $(document).ready(() => {
        // Hide the loader and show the table and geo button
        $("#reports-table").removeClass("invisible");
        $("#reports-view-geo-btn").removeClass("d-none");
        $("#reports-table-loading").remove();

        const table = $("#reports-table").DataTable({

          // Scroll x plane
          scrollX: true,

          colReorder: true,

          // Notes & source column max length 64 char and generate popup text
          columnDefs: [
            {
              targets: [-4, -3],
              className: "truncate",
              render: function (data) {
                return `<a data-toggle="popover" data-trigger="focus" tabindex="0" data-content="${data}">${data}</a>`;
              },
            },
          ],

          // Add search panes for 5 columns
          searchPanes: {
            threshold: 1,
            columns: [4, 5, 6, 8, 12, 15],
          },

          // Enable route in app.js to put workload on server
          processing: true,
          ajax: {
              url: '/api/reports',
              type: 'GET',
          },

          // Build the DOM for Bootstrap and datatables
          dom:
            "<'row'<'my-2 query-builder col-sm-12 col-md-12 col-lg-12'Q>>" +
            "<'row'<'my-2 date-picker-container row col-sm-12 col-md-12 col-lg-12'>>" +
            "<'row'<'float-lg-right col-sm-4 col-md-4 col-lg-9'B><'col-sm-4 col-md-4 col-lg-1'l><'col-sm-4 col-md-4 col-lg-2'f>>" +
            "<'row'<'col-sm-12 col-md-4'i><'col-sm-12 col-md-8'p>>" +
            "<'row'<'col-lg-12'tr>>",

          // B U T T O N S
          buttons: ["copy", "excel", "csv", "pdf", "print", "colvis", { text: 'Toggle Search Panes', action: () => 
      $(".dtsp-container").fadeToggle()}, { text: 'Toggle Query Builder', action: () => $(".query-builder").fadeToggle()}],
        });

        // Add the search panes to the table top
        table.searchPanes.container().prependTo(table.table().container());

        // Enable tooltips
        $(function () {
          $('[data-toggle="popover"]').popover({ trigger: "hover" });
        });

        // On table draws, update rows and rebuilt popovers
        // Current visible rows
        currentRows = [...table.columns({ search: 'applied' }).data()[0]];
        table.on("draw", function () {
          $('[data-toggle="popover"]').popover({ trigger: "hover" });
          // Current visible rows
          currentRows = table.columns({ search: 'applied' }).data()[0];
        });

         // On geo button click, move to map with data
        $("#reports-view-geo-btn").click(() => {
          const form = $(`
            <form action="/geo" method="post">
              <input type="text" name="report_ids" value="${currentRows}"/>
            </form>`);
          $("body").append(form);
          form.submit();
        });

        // Add date pickers
        $(".date-picker-container").html(
          `
          <div class="input-group input-date-range col-6">
            <div class="input-group-prepend">
              <span class="input-group-text">From date:</span>
            </div>
            <input type="date" id="min-date" class="form-control date-range-filter" data-date-format="yyyy-mm-dd">
          </div> 
          <div class="input-group input-date-range col-6">
            <div class="input-group-prepend">
              <span class="input-group-text">To date:</span>
            </div> 
            <input type="date" id="max-date" class="form-control date-range-filter" data-date-format="yyyy-mm-dd">
          </div>
          `
        )
        
        // Extend dataTables search
        $.fn.dataTable.ext.search.push(
          function(settings, searchData, index, rowData, counter) {
            const min = $('#min-date').val();
            const max = $('#max-date').val();
            const timestamp = searchData[21];

            if (
              (!min || !max) ||
              (moment(timestamp).isSameOrAfter(min) && moment(timestamp).isSameOrBefore(max))
            ) {
              return true;
            }
            return false;
          }
        );

        // Re-draw the table when the a date range filter changes
        $('.date-range-filter').change(() => table.draw());
      });
    </script>
  </body>
</html>
